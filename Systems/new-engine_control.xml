<?xml version="1.0"?>

<system name="Engine-Ctl">
    
    <property value="0"> animation/electrical-master-switch</property>
     <property value="0">systems/engine/left-starter</property>
     <property value="0">systems/engine/right-starter</property>
     <property value="0">systems/engine/left-starter-timer</property>
     <property value="0">systems/engine/right-starter-timer</property>
     
     
     <channel name="Power Engines Active">
	 
	 <switch name="propulsion/power-eng-active-sw">
	     <default value="0"/>
	    <test logic="AND" value="2">
		systems/engine/left-engine == 1
		systems/engine/right-engine == 1
	    </test>
	    <test logic="OR" value="1">
		systems/engine/left-engine == 1
		systems/engine/right-engine == 1
	    </test>
	    <output>propulsion/power-eng-active</output>
	</switch>
	
	<switch name="systems/engine/left-cutoff-sw">
	     <default value="0"/>
	    <test logic="OR" value="1">
		systems/engine/left-engine == 0
		systems/engine/left-cutoff == 1
	    </test>	    
	</switch>
	
	<switch name="systems/engine/right-cutoff-sw">
	     <default value="0"/>
	    <test logic="OR" value="1">
		systems/engine/right-engine == 0
		systems/engine/right-cutoff == 1
	    </test>	    
	</switch>
	
	<switch name="systems/engine/cutoff-sw">
	     <default value="1"/>
	    <test logic="OR" value="0">
		systems/engine/left-cutoff-sw == 0
		systems/engine/right-cutoff-sw == 0
	    </test>	    	    
	</switch>
	
	
	<switch name="systems/engine/left-engine-rpm_sw">
	     <default value="0"/>
	    <test logic="OR" value="propulsion/engine[0]/engine-rpm">
		systems/engine/left-engine == 1
	    </test>
	    <output>systems/engine/left-engine-rpm</output>
	</switch>
	
	<switch name="systems/engine/right-engine-rpm_sw">
	     <default value="0"/>
	    <test logic="OR" value="propulsion/engine[0]/engine-rpm">
		systems/engine/right-engine == 1
	    </test>
	    <output>systems/engine/right-engine-rpm</output>
	</switch>
	
    </channel>
      
      
      <channel name="Start-Process Left ">
	
	 <switch name="systems/engine/left-start-state-sw">
           <default value="systems/engine/left-start-state"/>
	   <test logic="AND" value="0">
                propulsion/engine[0]/cutoff  == 1
           </test>
           <test logic="AND" value="1">
                propulsion/engine[0]/cutoff  == 0
              electrical/supplier/battery-on  == 1
	      electrical/switch/alternator  == 1
	      systems/engine/left-engine == 1
           </test>
	   <output>systems/engine/left-start-state</output>
	</switch>
	
	
	<switch name="systems/engine/left-fuel-pump-sw">
           <default value="0"/>
	   <test logic="AND" value="1">
                propulsion/engine[0]/cutoff  == 0
		electrical/outputs/fuel-pump GT 27
           </test>
	    <output>systems/engine/left-fuel-pump</output>
	</switch>
	
	
	
       
        <switch name="systems/engine/left-starter-sw1">
           <default value="0"/>
	    <test logic="OR" value="0">
	      propulsion/engine/set-running == 1
	      systems/engine/left-starter-timer == 1
	      propulsion/engine/n1 GT 60
           </test>
	   <test logic="AND" value="systems/engine/left-starter">
              animation/electrical-master-switch  == 1
           </test>
	   <output>systems/engine/left-starter</output>
       </switch>
       
       
        <kinematic name="fcs/left-starter-timer">
            <input>systems/engine/left-starter</input>
            <traverse>
                <setting>
                    <position>0</position>
                    <time>0</time>
                </setting>
                <setting>
                    <position>1</position>
                    <time>5</time>
                </setting>
            </traverse>
            <output>systems/engine/left-starter-timer</output>
        </kinematic>
	
	
	<!--<switch name="systems/engine/left-starter-sw2">
           <default value="0"/>
           <test logic="AND" value="1">
             systems/engine/left-starter-timer GT 0
	     systems/engine/left-starter-timer LT 1
           </test>
	   <output>propulsion/engine[0]/starter</output>
       </switch>-->
	
    </channel> 
    
    <channel name="Start-Process Right ">
	
	 <switch name="systems/engine/right-start-state-sw">
           <default value="systems/engine/right-start-state"/>
	   <test logic="AND" value="0">
                propulsion/engine[0]/cutoff  == 1
           </test>
           <test logic="AND" value="1">
                propulsion/engine[0]/cutoff  == 0
              electrical/supplier/battery-on  == 1
	      electrical/switch/alternator  == 1
	      systems/engine/right-engine == 1
           </test>
	   <output>systems/engine/right-start-state</output>
	</switch>
	
	
	<switch name="systems/engine/right-fuel-pump-sw">
           <default value="0"/>
	   <test logic="AND" value="1">
                propulsion/engine[0]/cutoff  == 0
		electrical/outputs/fuel-pump GT 27
           </test>
	    <output>systems/engine/right-fuel-pump</output>
	</switch>
	
	
	
       
        <switch name="systems/engine/right-starter-sw1">
           <default value="0"/>
	    <test logic="OR" value="0">
	      propulsion/engine/set-running == 1
	      systems/engine/right-starter-timer == 1
	      propulsion/engine/n1 GT 60
           </test>
	   <test logic="AND" value="systems/engine/right-starter">
              animation/electrical-master-switch  == 1
           </test>
	   <output>systems/engine/right-starter</output>
       </switch>
       
       
        <kinematic name="fcs/right-starter-timer">
            <input>systems/engine/right-starter</input>
            <traverse>
                <setting>
                    <position>0</position>
                    <time>0</time>
                </setting>
                <setting>
                    <position>1</position>
                    <time>5</time>
                </setting>
            </traverse>
            <output>systems/engine/right-starter-timer</output>
        </kinematic>
	
	
	<!--<switch name="systems/engine/right-starter-sw2">
           <default value="0"/>
           <test logic="AND" value="1">
             systems/engine/right-starter-timer GT 0
	     systems/engine/right-starter-timer LT 1
           </test>
	   <output>propulsion/engine[0]/starter</output>
       </switch>-->
	
    </channel> 
    
    <channel name="Start-Process Common ">
	
	<switch name="systems/engine/starter-sw2">
           <default value="0"/>
	   <test logic="AND" value="1">
             systems/engine/left-starter-timer GT 0
	     systems/engine/left-starter-timer LT 1
           </test>
           <test logic="AND" value="1">
             systems/engine/right-starter-timer GT 0
	     systems/engine/right-starter-timer LT 1
           </test>
	   <output>propulsion/engine[0]/starter</output>
       </switch>    
       
       <switch name="systems/engine/fuel-pump">
	     <default value="0"/>
	    <test logic="OR" value="1">
		systems/engine/left-fuel-pump == 1
		systems/engine/right-fuel-pump == 1
	    </test>	    	    
	</switch>
    
     </channel> 
     
     
    <channel name="Trigger-StartStop-Engine">
	
	<!--progressive increase  n1 at start   (set to 20) -->
	
	 <switch name="animation/start-engine-n1-sw">
           <default value="animation/start-engine-n1-cmd"/>
	   <test logic="AND" value="1">
               propulsion/engine[0]/cutoff  == 0
               propulsion/engine[0]/starter == 1
           </test>
	   <test logic="OR" value="0">
               propulsion/engine[0]/cutoff  == 1
               propulsion/engine[0]/starter == 0
           </test>
	   <output>animation/start-engine-n1-cmd</output>
	</switch>
	
	<kinematic name="animation/start-engine-n1">
	    <input>animation/start-engine-n1-cmd</input>
	    <traverse>
	    <setting>
		<position> 0 </position>
		<time>     0 </time>
	    </setting>
	    <setting>
		<position> 1 </position>
		<time>     5 </time>
	    </setting>
	    </traverse>
	</kinematic>
	<pure_gain name="animation/engine-n1">
            <input>animation/start-engine-n1</input>
            <gain>20</gain>
        </pure_gain>
	<!--===========================================-->

       <switch name="systems/engine/n1">
           <default value="propulsion/engine/n1"/>
	   <test logic="AND" value="animation/engine-n1">
               propulsion/engine[0]/cutoff  == 0
               propulsion/engine[0]/starter == 1
               systems/engine/left-start-state  == 1
           </test>
	   <test logic="AND" value="animation/engine-n1">
               propulsion/engine[0]/cutoff  == 0
               propulsion/engine[0]/starter == 1
               systems/engine/right-start-state  == 1
           </test>
           <test logic="OR" value="0">
               systems/crash-detect/aero-on == 0
	       systems/sinking/propulsion == 0
            </test>
           <output>propulsion/engine/n1</output>
       </switch>

      <switch name="fcs/rpm-governor-active-norm-sw">
          <default value="fcs/rpm-governor-active-norm"/>
                <test logic="AND" value="0">
                    systems/crash-detect/aero-on == 0
              </test>
              <test logic="AND" value="1">
		    systems/engine/left-start-state == 1
		    propulsion/engine[0]/starter == 1
              </test>
	      <test logic="AND" value="1">
		systems/engine/right-start-state == 1
		propulsion/engine[0]/starter == 1
              </test>
              <test logic="AND" value="1">
		systems/engine/fuel-pump == 1
		propulsion/engine/rotor-rpm LT 400
              </test>
              <test logic="AND" value="0">
		systems/engine/left-start-state == 1
		propulsion/engine/rotor-rpm GE 400
              </test>
	       <test logic="AND" value="0">
		systems/engine/right-start-state == 1
		propulsion/engine/rotor-rpm GE 400
              </test>
              <output>fcs/rpm-governor-active-norm</output>
       </switch>
       

       <switch name="systems/engine/throttle-cmd">
           <default value="0"/>
           <test logic="AND" value="0.96">
               fcs/rpm-governor-active-norm == 1
               propulsion/engine[0]/set-running  == 1
           </test>
           <test logic="AND" value="0.2">
               propulsion/engine[0]/clutch-ctrl-norm  == 0
               propulsion/engine[0]/set-running  == 1
            </test>
        </switch>

        <kinematic name="systems/engine/throttle-max">
            <input>systems/engine/throttle-cmd</input>
            <traverse>
                <setting>
                    <position> 0 </position>
                    <time> 0 </time>
                </setting>
                <setting>
                    <position> 1 </position>
                    <time> 20 </time>
                </setting>
            </traverse>
        </kinematic>

    </channel>

    <!--<property value="0.0">fcs/rpm-governor-active-norm</property>-->

    <channel name="RPM-Governor">
        <switch name="fcs/rpm-governor-pid-inhibit">
            <default value="-1.0"/>
            <test value="0.0"> fcs/rpm-governor-active-norm GT 0.0 </test>
        </switch>
        <fcs_function name="fcs/rpm-delta">
            <function>
                <product>
                    <property> fcs/rpm-governor-active-norm </property>
                    <difference>
                        <property> fcs/nominal-rpm </property>
                        <property> propulsion/engine/engine-rpm </property>
                    </difference>
                </product>
            </function>
            <clipto>
                <min> -10.0 </min>
                <max> 10.0 </max>
            </clipto>
        </fcs_function>
        <pid name="fcs/throttle-pid">
            <input>fcs/rpm-delta</input>
            <kp> 0.880</kp>
            <ki> 0.008400 </ki>
            <kd> 0.1200   </kd>
            <trigger> fcs/rpm-governor-pid-inhibit </trigger>
            <clipto>
                <min>  0.01 </min>
                <max> systems/engine/throttle-max  </max>
            </clipto>
            <output>fcs/throttle-governor-pos-norm</output>
        </pid>


        <switch name="fcs/throttle-governor-pos">
            <default value="fcs/throttle-governor-pos-norm"/>
            <test logic="AND" value="0">
                propulsion/engine[0]/rotor-rpm  GT 300
            </test>
            <output>fcs/throttle-pos-norm</output>
        </switch>
  </channel>

</system>
