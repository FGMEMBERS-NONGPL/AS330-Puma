<?xml version="1.0"?>

<system name="Engine-Ctl">
    
    <property value="0"> animation/electrical-master-switch</property>
     <property value="0">systems/engine/starter</property>
     <property value="0">systems/engine/starter-timer</property>
      
      
      <channel name="Start-Process">
	
	 <switch name="systems/engine/start-state-sw">
           <default value="systems/engine/start-state"/>
	   <test logic="AND" value="0">
                propulsion/engine[0]/cutoff  == 1
           </test>
           <test logic="AND" value="1">
                propulsion/engine[0]/cutoff  == 0
              electrical/supplier/battery-on  == 1
	      electrical/switch/alternator  == 1
           </test>
	   <output>systems/engine/start-state</output>
	</switch>
	
	
	<switch name="systems/engine/fuel-pump-sw">
           <default value="0"/>
	   <test logic="AND" value="1">
                propulsion/engine[0]/cutoff  == 0
		electrical/outputs/fuel-pump GT 27
           </test>
	    <output>systems/engine/fuel-pump</output>
	</switch>
	
	
	
       
        <switch name="systems/engine/starter-sw1">
           <default value="0"/>
	    <test logic="OR" value="0">
	      propulsion/engine/set-running == 1
	      systems/engine/starter-timer == 1
	      propulsion/engine/n1 GT 60
           </test>
	   <test logic="AND" value="systems/engine/starter">
              animation/electrical-master-switch  == 1
           </test>
	   <output>systems/engine/starter</output>
       </switch>
       
       
        <kinematic name="fcs/starter-timer">
            <input>systems/engine/starter</input>
            <traverse>
                <setting>
                    <position>0</position>
                    <time>0</time>
                </setting>
                <setting>
                    <position>1</position>
                    <time>5</time>
                </setting>
            </traverse>
            <output>systems/engine/starter-timer</output>
        </kinematic>
	
	
	<switch name="systems/engine/starter-sw2">
           <default value="0"/>
           <test logic="AND" value="1">
             systems/engine/starter-timer GT 0
	     systems/engine/starter-timer LT 1
           </test>
	   <output>propulsion/engine[0]/starter</output>
       </switch>
	
    </channel> 
    
    <channel name="Trigger-StartStop-Engine">

       <switch name="systems/engine/n1">
           <default value="propulsion/engine/n1"/>
           <test logic="AND" value="20">
               propulsion/engine[0]/cutoff  == 0
               propulsion/engine[0]/starter == 1
               systems/engine/start-state  == 1
           </test>
           <test logic="AND" value="0">
               systems/crash-detect/aero-on == 0
            </test>
           <output>propulsion/engine/n1</output>
       </switch>

      <switch name="fcs/rpm-governor-active-norm-sw">
          <default value="fcs/rpm-governor-active-norm"/>
                <test logic="AND" value="0">
                    systems/crash-detect/aero-on == 0
              </test>
              <test logic="AND" value="1">
                 systems/engine/start-state == 1
                  propulsion/engine[0]/starter == 1
              </test>
              <test logic="AND" value="1">
                  systems/engine/fuel-pump == 1
                  propulsion/engine/rotor-rpm LT 400
              </test>
              <test logic="AND" value="0">
		   systems/engine/start-state == 1
                  propulsion/engine/rotor-rpm GE 400
              </test>
              <output>fcs/rpm-governor-active-norm</output>
       </switch>
       

       <switch name="systems/engine/throttle-cmd">
           <default value="0"/>
           <test logic="AND" value="0.96">
               fcs/rpm-governor-active-norm == 1
               propulsion/engine[0]/set-running  == 1
           </test>
           <test logic="AND" value="0.2">
               propulsion/engine[0]/clutch-ctrl-norm  == 0
               propulsion/engine[0]/set-running  == 1
            </test>
        </switch>

        <kinematic name="systems/engine/throttle-max">
            <input>systems/engine/throttle-cmd</input>
            <traverse>
                <setting>
                    <position> 0 </position>
                    <time> 0 </time>
                </setting>
                <setting>
                    <position> 1 </position>
                    <time> 20 </time>
                </setting>
            </traverse>
        </kinematic>

    </channel>

    <!--<property value="0.0">fcs/rpm-governor-active-norm</property>-->

    <channel name="RPM-Governor">
        <switch name="fcs/rpm-governor-pid-inhibit">
            <default value="-1.0"/>
            <test value="0.0"> fcs/rpm-governor-active-norm GT 0.0 </test>
        </switch>
        <fcs_function name="fcs/rpm-delta">
            <function>
                <product>
                    <property> fcs/rpm-governor-active-norm </property>
                    <difference>
                        <property> fcs/nominal-rpm </property>
                        <property> propulsion/engine/engine-rpm </property>
                    </difference>
                </product>
            </function>
            <clipto>
                <min> -10.0 </min>
                <max> 10.0 </max>
            </clipto>
        </fcs_function>
        <pid name="fcs/throttle-pid">
            <input>fcs/rpm-delta</input>
            <kp> 0.880</kp>
            <ki> 0.008400 </ki>
            <kd> 0.1200   </kd>
            <trigger> fcs/rpm-governor-pid-inhibit </trigger>
            <clipto>
                <min>  0.01 </min>
                <max> systems/engine/throttle-max  </max>
            </clipto>
            <output>fcs/throttle-governor-pos-norm</output>
        </pid>


        <switch name="fcs/throttle-governor-pos">
            <default value="fcs/throttle-governor-pos-norm"/>
            <test logic="AND" value="0">
                propulsion/engine[0]/rotor-rpm  GT 300
            </test>
            <output>fcs/throttle-pos-norm</output>
        </switch>
  </channel>

</system>
